# Claude Code プロジェクトルール

このファイルは、Claude Codeがこのプロジェクトで作業する際の共通ルールを定義します。

## プロジェクト概要

- **フレームワーク**: Ruby on Rails 7.1
- **Ruby バージョン**: 3.2.2
- **データベース**: MySQL
- **開発環境**: Docker Compose
- **主要機能**: Dog管理、OpenAI統合、GraphQL API

## 開発環境コマンド

### 基本的な開発コマンド
```bash
# データベース起動
make database

# 依存関係インストール
make bundle

# マイグレーション実行
make migrate

# アプリケーション起動
make web

# GraphQLスキーマ生成
make schema
```

### テスト・品質チェック
```bash
# セキュリティチェック
make brakeman

# RSpecテスト実行
make rspec

# テスト環境セットアップ
make test_db
make test_migrate
make test_bundle

# テスト環境クリーンアップ
make rspec_down
```

## コーディング規約

### Ruby/Rails規約

1. **メソッド分割**: 複雑なメソッドは小さな単位に分割する
2. **エラーハンドリング**: 適切な例外処理とログ出力を行う
3. **定数定義**: マジックナンバーや文字列は定数として定義する
4. **Rails.logger使用**: `puts`ではなく`Rails.logger`を使用する
5. **メモ化**: 重複する処理は`@var ||= ...`でメモ化する

### 命名規則

- **クラス名**: PascalCase (`ReflectShortStoryJob`)
- **メソッド名**: snake_case (`handle_completed_run`)
- **定数**: SCREAMING_SNAKE_CASE (`POLLING_INTERVAL`)
- **変数**: snake_case (`thread_id`, `run_id`)

### ファイル構成

- **Services**: `app/services/` - ビジネスロジック
- **Jobs**: `app/jobs/` - バックグラウンド処理
- **Resolvers**: `app/graphql/resolvers/` - GraphQLリゾルバー
- **Types**: `app/graphql/types/` - GraphQL型定義

## 品質保証

### 必須チェック

コード変更後は以下を実行すること：

1. **セキュリティチェック**:
   ```bash
   make brakeman
   ```

2. **テスト実行**:
   ```bash
   make rspec
   ```

3. **GraphQLスキーマ更新** (GraphQL変更時):
   ```bash
   make schema
   ```

### コミット前チェックリスト

- [ ] セキュリティチェック（brakeman）が通る
- [ ] 既存テストが通る
- [ ] 新機能にはテストを追加している
- [ ] ログ出力は適切か
- [ ] エラーハンドリングは十分か

## リファクタリング指針

### 優先度の高いリファクタリング対象

1. **重複コード**: 同様の処理が複数箇所にある
2. **長いメソッド**: 20行を超えるメソッド
3. **複雑な条件分岐**: ネストが深い条件分岐
4. **マジックナンバー**: ハードコードされた数値や文字列
5. **エラーハンドリング不足**: 例外処理が不十分な箇所

### リファクタリング手順

1. **テスト確認**: 既存テストが通ることを確認
2. **小さな単位で実行**: 一度に大きな変更を避ける
3. **テスト実行**: 各段階でテストを実行
4. **コミット**: 意味のある単位でコミット

## OpenAI統合ルール

### 設定値

- **ポーリング間隔**: 1秒
- **最大ポーリング時間**: 5分
- **クライアント**: メモ化して再利用

### エラーハンドリング

- API呼び出しの失敗は適切にログ出力
- タイムアウト設定を必ず行う
- 無限ループを避ける

## Docker使用ルール

- 開発環境は基本的にDockerを使用
- `make`コマンドを使用してDocker操作を標準化
- テスト環境も専用のDocker Compose設定を使用

## 禁止事項

- `puts`の使用（`Rails.logger`を使用）
- 無限ループ（`while true`）の使用
- マジックナンバーの直接使用
- エラーハンドリングなしのAPI呼び出し
- テストなしでの機能追加

## 推奨事項

- 早期リターンパターンの使用
- 適切な抽象化レベルでのメソッド分割
- 定数を使った設定値の管理
- 包括的なログ出力
- 意味のあるコミットメッセージ

---

このルールに従って、保守性と可読性の高いコードを維持しましょう。